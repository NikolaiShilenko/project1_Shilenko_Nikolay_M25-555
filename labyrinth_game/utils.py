import math

from .constants import ROOMS


def describe_current_room(game_state):
    """–û–ø–∏—Å–∞–Ω–∏–µ —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç—ã –∏–≥—Ä–æ–∫–∞"""
    # –ü–æ–ª—É—á–∞–µ–º –¥–∞–Ω–Ω—ã–µ –æ —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç–µ –∏–∑ ROOMS
    current_room_name = game_state['current_room']
    room_data = ROOMS[current_room_name]

    # –í—ã–≤–æ–¥–∏–º –Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã –≤ –≤–µ—Ä—Ö–Ω–µ–º —Ä–µ–≥–∏—Å—Ç—Ä–µ
    print(f"== {current_room_name.upper()} ==")

    # –í—ã–≤–æ–¥–∏–º –æ–ø–∏—Å–∞–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
    print(room_data['description'])

    # –í—ã–≤–æ–¥–∏–º —Å–ø–∏—Å–æ–∫ –ø—Ä–µ–¥–º–µ—Ç–æ–≤, –µ—Å–ª–∏ –æ–Ω–∏ –µ—Å—Ç—å
    if room_data['items']:
        print("–ó–∞–º–µ—Ç–Ω—ã–µ –ø—Ä–µ–¥–º–µ—Ç—ã:", ", ".join(room_data['items']))

    # –í—ã–≤–æ–¥–∏–º –¥–æ—Å—Ç—É–ø–Ω—ã–µ –≤—ã—Ö–æ–¥—ã
    if room_data['exits']:
        exits = [
            f"{direction} ({room})"
            for direction, room in room_data['exits'].items()
        ]
        print("–í—ã—Ö–æ–¥—ã:", ", ".join(exits))

    # –°–æ–æ–±—â–µ–Ω–∏–µ –æ –∑–∞–≥–∞–¥–∫–µ, –µ—Å–ª–∏ –æ–Ω–∞ –µ—Å—Ç—å
    if room_data['puzzle'] is not None:
        print("–ö–∞–∂–µ—Ç—Å—è, –∑–¥–µ—Å—å –µ—Å—Ç—å –∑–∞–≥–∞–¥–∫–∞ (–∏—Å–ø–æ–ª—å–∑—É–π—Ç–µ –∫–æ–º–∞–Ω–¥—É solve).")


def pseudo_random(seed, modulo):
    """–ì–µ–Ω–µ—Ä–∞—Ç–æ—Ä –ø—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω—ã—Ö —á–∏—Å–µ–ª –Ω–∞ –æ—Å–Ω–æ–≤–µ —Å–∏–Ω—É—Å–∞

    Args:
        seed (int): –Ω–∞—á–∞–ª—å–Ω–æ–µ –∑–Ω–∞—á–µ–Ω–∏–µ (–Ω–∞–ø—Ä–∏–º–µ—Ä, –∫–æ–ª–∏—á–µ—Å—Ç–≤–æ —à–∞–≥–æ–≤)
        modulo (int): –≤–µ—Ä—Ö–Ω—è—è –≥—Ä–∞–Ω–∏—Ü–∞ –¥–∏–∞–ø–∞–∑–æ–Ω–∞ [0, modulo)

    Returns:
        int: –ø—Å–µ–≤–¥–æ—Å–ª—É—á–∞–π–Ω–æ–µ —á–∏—Å–ª–æ –≤ –¥–∏–∞–ø–∞–∑–æ–Ω–µ [0, modulo)
    """
    # –í—ã—á–∏—Å–ª—è–µ–º —Å–∏–Ω—É—Å –æ—Ç seed —É–º–Ω–æ–∂–µ–Ω–Ω–æ–≥–æ –Ω–∞ –±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ
    sin_value = math.sin(seed * 12.9898)

    # –£–º–Ω–æ–∂–∞–µ–º –Ω–∞ –¥—Ä—É–≥–æ–µ –±–æ–ª—å—à–æ–µ —á–∏—Å–ª–æ –¥–ª—è "—Ä–∞–∑–º–∞–∑—ã–≤–∞–Ω–∏—è" –∑–Ω–∞—á–µ–Ω–∏–π
    multiplied = sin_value * 43758.5453

    # –ü–æ–ª—É—á–∞–µ–º –¥—Ä–æ–±–Ω—É—é —á–∞—Å—Ç—å
    fractional_part = multiplied - math.floor(multiplied)

    # –ü—Ä–∏–≤–æ–¥–∏–º –∫ –Ω—É–∂–Ω–æ–º—É –¥–∏–∞–ø–∞–∑–æ–Ω—É –∏ –≤–æ–∑–≤—Ä–∞—â–∞–µ–º —Ü–µ–ª–æ–µ —á–∏—Å–ª–æ
    return math.floor(fractional_part * modulo)


def trigger_trap(game_state):
    """–ê–∫—Ç–∏–≤–∞—Ü–∏—è –ª–æ–≤—É—à–∫–∏ —Å –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–º–∏ –ø–æ—Å–ª–µ–¥—Å—Ç–≤–∏—è–º–∏ –¥–ª—è –∏–≥—Ä–æ–∫–∞

    Args:
        game_state (dict): —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    """
    print("–õ–æ–≤—É—à–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞–Ω–∞! –ü–æ–ª —Å—Ç–∞–ª –¥—Ä–æ–∂–∞—Ç—å...")

    inventory = game_state['player_inventory']

    # –ü—Ä–æ–≤–µ—Ä—è–µ–º –µ—Å—Ç—å –ª–∏ –ø—Ä–µ–¥–º–µ—Ç—ã –≤ –∏–Ω–≤–µ–Ω—Ç–∞—Ä–µ
    if inventory:
        # –í—ã–±–∏—Ä–∞–µ–º —Å–ª—É—á–∞–π–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç –¥–ª—è —É–¥–∞–ª–µ–Ω–∏—è
        random_index = pseudo_random(game_state['steps_taken'], len(inventory))
        lost_item = inventory.pop(random_index)
        print(f"–ò–∑ –≤–∞—à–µ–≥–æ –∏–Ω–≤–µ–Ω—Ç–∞—Ä—è –≤—ã–ø–∞–ª –∏ –ø–æ—Ç–µ—Ä—è–ª—Å—è: {lost_item}")

    else:
        # –ò–Ω–≤–µ–Ω—Ç–∞—Ä—å –ø—É—Å—Ç - –∏–≥—Ä–æ–∫ –ø–æ–ª—É—á–∞–µ—Ç "—É—Ä–æ–Ω"
        damage_chance = pseudo_random(game_state['steps_taken'], 10)

        if damage_chance < 3:  # 30% —à–∞–Ω—Å –ø—Ä–æ–∏–≥—Ä—ã—à–∞
            print("–ö–∞–º–µ–Ω–Ω–∞—è –ø–ª–∏—Ç–∞ —Å –≥—Ä–æ—Ö–æ—Ç–æ–º –æ–±—Ä—É—à–∏–≤–∞–µ—Ç—Å—è –Ω–∞ –≤–∞—Å! –ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞.")
            game_state['game_over'] = True
        else:
            print("–í–∞–º —É–¥–∞–ª–æ—Å—å —É–≤–µ—Ä–Ω—É—Ç—å—Å—è –æ—Ç –ø–∞–¥–∞—é—â–∏—Ö –∫–∞–º–Ω–µ–π! –í—ã —É—Ü–µ–ª–µ–ª–∏.")


def random_event(game_state):
    """–°–ª—É—á–∞–π–Ω—ã–µ —Å–æ–±—ã—Ç–∏—è –ø—Ä–∏ –ø–µ—Ä–µ–º–µ—â–µ–Ω–∏–∏ –∏–≥—Ä–æ–∫–∞

    Args:
        game_state (dict): —Ç–µ–∫—É—â–µ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∏–≥—Ä—ã
    """
    # –ü—Ä–æ–≤–µ—Ä—è–µ–º, –ø—Ä–æ–∏–∑–æ–π–¥–µ—Ç –ª–∏ —Å–æ–±—ã—Ç–∏–µ (10% —à–∞–Ω—Å)
    event_chance = pseudo_random(game_state['steps_taken'], 10)
    if event_chance != 0:
        return  # –°–æ–±—ã—Ç–∏–µ –Ω–µ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç

    # –í—ã–±–∏—Ä–∞–µ–º —Ç–∏–ø —Å–æ–±—ã—Ç–∏—è
    event_type = pseudo_random(game_state['steps_taken'] + 1, 3)
    current_room = game_state['current_room']

    if event_type == 0:
        # –°—Ü–µ–Ω–∞—Ä–∏–π 1: –ù–∞—Ö–æ–¥–∫–∞
        print("–í—ã –∑–∞–º–µ—Ç–∏–ª–∏ —á—Ç–æ-—Ç–æ –±–ª–µ—Å—Ç—è—â–µ–µ –Ω–∞ –ø–æ–ª—É... –≠—Ç–æ –º–æ–Ω–µ—Ç–∫–∞!")
        game_state['rooms'][current_room]['items'].append('coin')

    elif event_type == 1:
        # –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ò—Å–ø—É–≥
        print("–í—ã —Å–ª—ã—à–∏—Ç–µ –ø–æ–¥–æ–∑—Ä–∏—Ç–µ–ª—å–Ω—ã–π —à–æ—Ä–æ—Ö –∏–∑ —Ç–µ–º–Ω–æ—Ç—ã...")
        if 'sword' in game_state['player_inventory']:
            print("–í—ã –¥–æ—Å—Ç–∞—ë—Ç–µ –º–µ—á, –∏ —Å—É—â–µ—Å—Ç–≤–æ —Ä–µ—Ç–∏—Ä—É–µ—Ç—Å—è!")
        else:
            print("–®–æ—Ä–æ—Ö —É—Å–∏–ª–∏–≤–∞–µ—Ç—Å—è... –í–∞–º —Å—Ç–∞–ª–æ –Ω–µ –ø–æ —Å–µ–±–µ.")

    elif event_type == 2:
        # –°—Ü–µ–Ω–∞—Ä–∏–π 3: –°—Ä–∞–±–∞—Ç—ã–≤–∞–Ω–∏–µ –ª–æ–≤—É—à–∫–∏
        if (current_room == 'trap_room' and
                'torch' not in game_state['player_inventory']):
            print("–í—ã —Å–ª—ã—à–∏—Ç–µ —â–µ–ª—á–æ–∫ –ø–æ–¥ –Ω–æ–≥–æ–π... –≠—Ç–æ –ª–æ–≤—É—à–∫–∞!")
            trigger_trap(game_state)
        else:
            print("–ü–æ–∫–∞–∑–∞–ª–æ—Å—å, —á—Ç–æ —á—Ç–æ-—Ç–æ —â—ë–ª–∫–Ω—É–ª–æ, –Ω–æ –Ω–∏—á–µ–≥–æ –Ω–µ –ø—Ä–æ–∏–∑–æ—à–ª–æ.")


def solve_puzzle(game_state):
    """–†–µ—à–µ–Ω–∏–µ –∑–∞–≥–∞–¥–∫–∏ –≤ —Ç–µ–∫—É—â–µ–π –∫–æ–º–Ω–∞—Ç–µ"""
    current_room_name = game_state['current_room']
    room_data = game_state['rooms'][current_room_name]

    if room_data['puzzle'] is None:
        print("–ó–¥–µ—Å—å –Ω–µ—Ç –∑–∞–≥–∞–¥–∫–∏ –¥–ª—è —Ä–µ—à–µ–Ω–∏—è.")
        return

    puzzle_text, correct_answer, *alternative_answers = room_data['puzzle']

    # –°–æ–∑–¥–∞–µ–º —Å–ø–∏—Å–æ–∫ –≤—Å–µ—Ö –¥–æ–ø—É—Å—Ç–∏–º—ã—Ö –æ—Ç–≤–µ—Ç–æ–≤
    all_answers = [correct_answer]
    if alternative_answers:
        all_answers.extend(alternative_answers[0])

    print(f"–ó–∞–≥–∞–¥–∫–∞: {puzzle_text}")
    user_answer = input("–í–∞—à –æ—Ç–≤–µ—Ç: ").strip().lower()

    if user_answer in all_answers:
        print("–ü—Ä–∞–≤–∏–ª—å–Ω–æ! –ó–∞–≥–∞–¥–∫–∞ —Ä–µ—à–µ–Ω–∞.")

        # –ù–∞–≥—Ä–∞–¥–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–º–Ω–∞—Ç—ã
        if current_room_name == 'hall':
            print("–ü—å–µ–¥–µ—Å—Ç–∞–ª –æ—Ç–∫—Ä—ã–≤–∞–µ—Ç—Å—è! –í—ã –ø–æ–ª—É—á–∞–µ—Ç–µ —Å–µ—Ä–µ–±—Ä—è–Ω—ã–π –∫–ª—é—á.")
            game_state['player_inventory'].append('silver_key')
        elif current_room_name == 'trap_room':
            print("–ü–ª–∏—Ç—ã –ø–µ—Ä–µ—Å—Ç–∞–ª–∏ –¥–≤–∏–≥–∞—Ç—å—Å—è! "
                  "–¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –±–µ–∑–æ–ø–∞—Å–Ω–æ –∏—Å—Å–ª–µ–¥–æ–≤–∞—Ç—å –∫–æ–º–Ω–∞—Ç—É.")
            # –ú–æ–∂–Ω–æ –¥–æ–±–∞–≤–∏—Ç—å —Å–ø–µ—Ü–∏–∞–ª—å–Ω—ã–π –ø—Ä–µ–¥–º–µ—Ç –∏–ª–∏ –∏–∑–º–µ–Ω–∏—Ç—å —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–æ–º–Ω–∞—Ç—ã
        elif current_room_name == 'library':
            print("–°–≤–∏—Ç–æ–∫ —Ä–∞—Å–∫—Ä—ã–≤–∞–µ—Ç—Å—è! –í—ã –Ω–∞—Ö–æ–¥–∏—Ç–µ —Å–∫—Ä—ã—Ç—ã–π –æ—Ç—Å–µ–∫ —Å –∫–∞—Ä—Ç–æ–π.")
            game_state['player_inventory'].append('secret_map')
        elif current_room_name == 'observatory':
            print("–¢–µ–ª–µ—Å–∫–æ–ø –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç—Å—è! –¢–µ–ø–µ—Ä—å –≤—ã –º–æ–∂–µ—Ç–µ –≤–∏–¥–µ—Ç—å –∑–≤–µ–∑–¥—ã –ª—É—á—à–µ.")
            game_state['player_inventory'].append('enhanced_telescope')

        # –£–±–∏—Ä–∞–µ–º –∑–∞–≥–∞–¥–∫—É –ø–æ—Å–ª–µ —Ä–µ—à–µ–Ω–∏—è
        room_data['puzzle'] = None

    else:
        print("–ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω—ã–π –æ—Ç–≤–µ—Ç. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑.")

        # –û—Å–æ–±–æ–µ –ø–æ–≤–µ–¥–µ–Ω–∏–µ –¥–ª—è trap_room –ø—Ä–∏ –Ω–µ–≤–µ—Ä–Ω–æ–º –æ—Ç–≤–µ—Ç–µ
        if current_room_name == 'trap_room':
            print("–õ–æ–≤—É—à–∫–∞ –∞–∫—Ç–∏–≤–∏—Ä—É–µ—Ç—Å—è!")
            trigger_trap(game_state)


def attempt_open_treasure(game_state):
    """–ü–æ–ø—ã—Ç–∫–∞ –æ—Ç–∫—Ä—ã—Ç—å —Å—É–Ω–¥—É–∫ —Å —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏"""
    if game_state['current_room'] != 'treasure_room':
        print("–ó–¥–µ—Å—å –Ω–µ—Ç —Å—É–Ω–¥—É–∫–∞ —Å —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏.")
        return

    if 'rusty_key' not in game_state['player_inventory']:
        print("–°—É–Ω–¥—É–∫ –∑–∞–ø–µ—Ä—Ç. –ù—É–∂–µ–Ω –∫–ª—é—á, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å –µ–≥–æ.")
        return

    print("–í—ã –∏—Å–ø–æ–ª—å–∑—É–µ—Ç–µ –∫–ª—é—á, —á—Ç–æ–±—ã –æ—Ç–∫—Ä—ã—Ç—å —Å—É–Ω–¥—É–∫ —Å —Å–æ–∫—Ä–æ–≤–∏—â–∞–º–∏!")
    print("üéâ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! –í—ã –Ω–∞—à–ª–∏ —Å–æ–∫—Ä–æ–≤–∏—â–∞ –∏ –≤—ã–∏–≥—Ä–∞–ª–∏ –∏–≥—Ä—É! üéâ")
    game_state['game_over'] = True
